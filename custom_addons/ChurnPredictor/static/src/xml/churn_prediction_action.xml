<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <t t-name="ChurnPredictor.ChurnPredictionSPATemplate">
        <div class="o_churn_spa p-4">

            <!-- ======================= MÀN HÌNH DANH SÁCH ======================= -->
            <div t-if="state.currentView === 'list'">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h1 class="h3">Churn Predictions</h1>
                    <!-- Nút bấm để tải lại danh sách -->
                    <button class="btn btn-secondary" t-on-click="loadListData">
                        <i class="fa fa-refresh"/> Refresh
                    </button>
                </div>
                
                <div t-if="state.isLoadingList" class="text-center my-5">
                    <i class="fa fa-spinner fa-spin fa-3x"/>
                </div>

                <table t-if="!state.isLoadingList" class="table table-striped o_list_view">
                    <thead>
                        <tr>
                            <th>Prediction Date</th>
                            <th>Customer Name</th>
                            <th>Prediction Result</th>
                            <th>Churn Probability (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="state.records" t-as="record" t-key="record.id">
                            <tr t-on-click="() => this.selectRecord(record.id)" style="cursor: pointer;">
                                <td><span t-esc="record.prediction_date"/></td>
                                <td><span t-esc="record.customer_name"/></td>
                                <td>
                                    <span t-if="record.prediction_result === 'churn'" class="badge text-bg-danger">Churn</span>
                                    <span t-if="record.prediction_result === 'no_churn'" class="badge text-bg-success">No Churn</span>
                                </td>
                                <td><span t-esc="record.probability.toFixed(2)"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </div>

            <!-- ======================= MÀN HÌNH CHI TIẾT ======================= -->
            <div t-if="state.currentView === 'detail'">
                <div class="o_control_panel">
                    <div class="o_cp_left">
                        <div class="o_cp_breadcrumb">
                            <li class="breadcrumb-item"><a href="#" t-on-click="backToList">Predictions</a></li>
                            <li class="breadcrumb-item active" t-esc="state.activeRecord ? state.activeRecord.customer_id[1] : ''"/>
                        </div>
                    </div>
                </div>

                <div t-if="state.isLoadingDetail" class="text-center my-5">
                    <i class="fa fa-spinner fa-spin fa-3x"/>
                </div>

                <div t-if="!state.isLoadingDetail and state.activeRecord" class="o_form_sheet_bg mt-3">
                    <div class="o_form_sheet">
                        <h1><span t-esc="state.activeRecord.customer_id[1]"/></h1>
                        <hr/>
                        <p><strong>Prediction Date:</strong> <span t-esc="state.activeRecord.prediction_date"/></p>
                        <p><strong>Prediction Result:</strong> 
                            <span t-if="state.activeRecord.prediction_result === 'churn'" class="badge text-bg-danger">Churn</span>
                            <span t-if="state.activeRecord.prediction_result === 'no_churn'" class="badge text-bg-success">No Churn</span>
                        </p>
                        <p><strong>Churn Probability:</strong> <span t-esc="state.activeRecord.probability.toFixed(2)"/> %</p>
                        
                        <!-- NÚT BẤM DUY NHẤT VÀ QUAN TRỌNG NHẤT -->
                        <button class="btn btn-primary mt-4" t-on-click="onViewShapInNewTab">
                            <i class="fa fa-line-chart"/> View SHAP Explanation in New Tab
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </t>

</templates>