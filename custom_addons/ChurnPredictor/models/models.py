# -*- coding: utf-8 -*-
import base64
import json # <<< THÃŠM Má»šI
import requests # <<< THÃŠM Má»šI
import logging # <<< THÃŠM Má»šI
import markdown2 # <<< THÃŠM Má»šI

from odoo import models, fields, api, _ # <<< THÃŠM _
from odoo.exceptions import UserError # <<< THÃŠM Má»šI
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

_logger = logging.getLogger(__name__)

class ChurnPrediction(models.Model):
    """
    Model nÃ y dÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ káº¿t quáº£ cá»§a má»—i láº§n dá»± Ä‘oÃ¡n churn.
    Má»—i báº£n ghi (record) trong model nÃ y tÆ°Æ¡ng á»©ng vá»›i má»™t láº§n cháº¡y dá»± Ä‘oÃ¡n
    cho má»™t khÃ¡ch hÃ ng táº¡i má»™t thá»i Ä‘iá»ƒm cá»¥ thá»ƒ.
    """
    _name = 'churn.prediction'
    _description = 'Customer Churn Prediction Result'
    _order = 'prediction_date desc' # Sáº¯p xáº¿p máº·c Ä‘á»‹nh theo ngÃ y dá»± Ä‘oÃ¡n má»›i nháº¥t

    # --- CÃ¡c trÆ°á»ng (Fields) chÃ­nh cá»§a Model ---

    # Má»‘i quan há»‡ Many2one: Má»—i káº¿t quáº£ dá»± Ä‘oÃ¡n thuá»™c vá» Má»˜T khÃ¡ch hÃ ng.
    # 'res.partner' lÃ  model máº·c Ä‘á»‹nh cá»§a Odoo Ä‘á»ƒ quáº£n lÃ½ liÃªn há»‡ (khÃ¡ch hÃ ng, nhÃ  cung cáº¥p...).
    customer_id = fields.Many2one(
        'res.partner',
        string='Customer',
        required=True,
        ondelete='cascade', # Náº¿u khÃ¡ch hÃ ng bá»‹ xÃ³a, káº¿t quáº£ dá»± Ä‘oÃ¡n liÃªn quan cÅ©ng bá»‹ xÃ³a.
        help="The customer for whom the prediction was made."
    )

    # NgÃ y vÃ  giá» thá»±c hiá»‡n dá»± Ä‘oÃ¡n. Máº·c Ä‘á»‹nh lÃ  thá»i Ä‘iá»ƒm táº¡o báº£n ghi.
    prediction_date = fields.Datetime(
        string='Prediction Date',
        required=True,
        default=fields.Datetime.now,
        readonly=True,
        help="Date and time when the prediction was generated."
    )

    # Káº¿t quáº£ dá»± Ä‘oÃ¡n (dáº¡ng lá»±a chá»n).
    prediction_result = fields.Selection(
        [
            ('churn', 'Churn'),
            ('no_churn', 'No Churn')
        ],
        string='Prediction Result',
        required=False,
        help="The outcome predicted by the model (Churn or No Churn)."
    )

    # XÃ¡c suáº¥t khÃ¡ch hÃ ng sáº½ rá»i bá» (tá»« 0.0 Ä‘áº¿n 100.0).
    probability = fields.Float(
        string='Churn Probability (%)',
        digits=(16, 2), # Hiá»ƒn thá»‹ vá»›i 2 chá»¯ sá»‘ tháº­p phÃ¢n.
        store=True, # ThÃªm store=True Ä‘á»ƒ Ä‘áº£m báº£o hiá»‡u suáº¥t
        group_operator='avg', # THÃŠM DÃ’NG QUAN TRá»ŒNG NÃ€Y VÃ€O
        help="The probability (from 0 to 100) that the customer will churn, as calculated by the model."
    )

    # TrÆ°á»ng HTML Ä‘á»ƒ lÆ°u vÃ  hiá»ƒn thá»‹ biá»ƒu Ä‘á»“ giáº£i thÃ­ch tá»« SHAP.
    # ChÃºng ta sáº½ lÆ°u trá»±c tiáº¿p mÃ£ HTML cá»§a biá»ƒu Ä‘á»“ vÃ o Ä‘Ã¢y.
    shap_html = fields.Binary(
        string='Prediction Explanation (SHAP Data)',
        readonly=True
    )
    # TrÆ°á»ng Text Ä‘á»ƒ lÆ°u dá»¯ liá»‡u SHAP thÃ´ dáº¡ng JSON.
    # Dá»¯ liá»‡u nÃ y sáº½ Ä‘Æ°á»£c gá»­i tá»›i AI Ä‘á»ƒ diá»…n giáº£i.
    shap_data_json = fields.Text(
        string='SHAP Raw Data (JSON)',
        readonly=True,
        help="Raw SHAP data (base value, feature values, SHAP values) stored in JSON format, used for generating AI explanations."
    )

    shap_ai_explanation = fields.Text(
        string='AI-Powered Explanation',
        readonly=True,
        help="The natural language explanation of the prediction, generated by an AI service."
    )

    # ThÃªm má»™t trÆ°á»ng Ä‘á»ƒ hiá»ƒn thá»‹ tÃªn khÃ¡ch hÃ ng cho tiá»‡n lá»£i
    # related='customer_id.name' sáº½ tá»± Ä‘á»™ng láº¥y giÃ¡ trá»‹ tá»« trÆ°á»ng 'name' cá»§a model 'res.partner'
    customer_name = fields.Char(
        string="Customer Name",
        related='customer_id.name',
        readonly=True,
        store=True # LÆ°u vÃ o DB Ä‘á»ƒ cÃ³ thá»ƒ tÃ¬m kiáº¿m/nhÃ³m theo tÃªn
    )
    
    churn_rate = fields.Float(
        string="Churn Rate",
        compute='_compute_churn_rate',
        store=True, # store=True lÃ  báº¯t buá»™c Ä‘á»ƒ cÃ³ thá»ƒ group by vÃ  tÃ­nh toÃ¡n trÃªn view
        group_operator='avg', # Chá»‰ Ä‘á»‹nh cÃ¡ch Odoo tá»•ng há»£p trÆ°á»ng nÃ y
    )    
    
    customer_state_id = fields.Many2one(
        'res.country.state', 
        string='Customer State',
        related='customer_id.state_id',
        store=True, # Báº¯t buá»™c pháº£i cÃ³ store=True Ä‘á»ƒ cÃ³ thá»ƒ group_by
        readonly=True,
    )
    
    probability_level = fields.Selection(
        [
            ('low', 'Low Risk (0-30%)'),
            ('medium', 'Medium Risk (30-70%)'),
            ('high', 'High Risk (70-100%)')
        ],
        string="Probability Level",
        compute='_compute_probability_level',
        store=True, # Báº¯t buá»™c pháº£i cÃ³ store=True Ä‘á»ƒ cÃ³ thá»ƒ group_by
    )
    
    is_high_risk = fields.Integer(
        string="Is High Risk",
        compute='_compute_is_high_risk',
        store=True, # Báº¯t buá»™c Ä‘á»ƒ cÃ³ thá»ƒ tÃ­nh toÃ¡n trÃªn view
        default=0,
    )
    
    product_count = fields.Integer(
        string="Number of Products Purchased",
        default=1, # Hoáº·c má»™t giÃ¡ trá»‹ máº·c Ä‘á»‹nh há»£p lÃ½
        help="The number of distinct products the customer has purchased."
    )
    
    x_feat_segment = fields.Integer(
        string="Customer Segment",
        related='customer_id.x_feat_segment',
        store=True, # Báº®T BUá»˜C Ä‘á»ƒ cÃ³ thá»ƒ group_by
        readonly=True
    )

    # Láº¥y trÆ°á»ng "Last Product Category" tá»« khÃ¡ch hÃ ng liÃªn quan
    x_feat_product_category_name_english_last = fields.Char(
        string="Last Product Category",
        related='customer_id.x_feat_product_category_name_english_last',
        store=True, # Báº®T BUá»˜C Ä‘á»ƒ cÃ³ thá»ƒ group_by
        readonly=True
    )

    # Láº¥y trÆ°á»ng "Category Avg Gap" tá»« khÃ¡ch hÃ ng liÃªn quan
    x_feat_category_avg_gap = fields.Float(
        string="Category Avg Gap (Days)",
        related='customer_id.x_feat_category_avg_gap',
        store=True, # Báº®T BUá»˜C Ä‘á»ƒ cÃ³ thá»ƒ sá»­ dá»¥ng lÃ m measure
        readonly=True,
        group_operator='avg' # Chá»‰ Ä‘á»‹nh phÃ©p tÃ­nh máº·c Ä‘á»‹nh lÃ  trung bÃ¬nh
    )
    
    x_feat_payment_type_last = fields.Char(
        string="Last Payment Type",
        related='customer_id.x_feat_payment_type_last',
        store=True,
        readonly=True
    )
    
    x_feat_recency = fields.Integer(
        string="Recency (Days)",
        related='customer_id.x_feat_recency',
        store=True,
        readonly=True,
        group_operator='avg'
    )
    x_feat_frequency = fields.Integer(
        string="Frequency",
        related='customer_id.x_feat_frequency',
        store=True,
        readonly=True,
        group_operator='avg'
    )
    x_feat_payment_value_sum = fields.Float(
        string="Total Spent",
        related='customer_id.x_feat_payment_value_sum',
        store=True,
        readonly=True,
        group_operator='avg'
    )

    @api.depends('probability_level')
    def _compute_is_high_risk(self):
        """
        GÃ¡n giÃ¡ trá»‹ 1 náº¿u lÃ  'high', ngÆ°á»£c láº¡i lÃ  0.
        Viá»‡c tÃ­nh tá»•ng (sum) cá»§a trÆ°á»ng nÃ y sáº½ cho ra sá»‘ khÃ¡ch hÃ ng nguy cÆ¡ cao.
        """
        for record in self:
            if record.probability_level == 'high':
                record.is_high_risk = 1
            else:
                record.is_high_risk = 0

    @api.depends('probability')
    def _compute_probability_level(self):
        """
        Tá»± Ä‘á»™ng phÃ¢n loáº¡i má»©c Ä‘á»™ rá»§i ro dá»±a trÃªn xÃ¡c suáº¥t churn.
        """
        for record in self:
            if record.probability < 30:
                record.probability_level = 'low'
            elif record.probability < 70:
                record.probability_level = 'medium'
            else:
                record.probability_level = 'high'

    @api.depends('prediction_result')
    def _compute_churn_rate(self):
        """
        TrÆ°á»ng nÃ y tráº£ vá» 100 náº¿u lÃ  churn, 0 náº¿u khÃ´ng.
        Khi tÃ­nh trung bÃ¬nh (avg) trÃªn view, nÃ³ sáº½ ra Ä‘Ãºng tá»· lá»‡ %.
        """
        for record in self:
            if record.prediction_result == 'churn':
                record.churn_rate = 100.0
            else:
                record.churn_rate = 0.0
                
    @api.model
    def get_dashboard_kpis(self, domain=None):
        """
        HÃ m nÃ y Ä‘Æ°á»£c gá»i tá»« JavaScript Ä‘á»ƒ láº¥y dá»¯ liá»‡u cho cÃ¡c Ã´ KPI.
        NÃ³ Ä‘Ã£ Ä‘Æ°á»£c nÃ¢ng cáº¥p Ä‘á»ƒ cháº¥p nháº­n má»™t `domain` Ä‘á»ƒ lá»c dá»¯ liá»‡u.
        """
        # Náº¿u khÃ´ng cÃ³ domain Ä‘Æ°á»£c truyá»n vÃ o, sá»­ dá»¥ng má»™t domain trá»‘ng (láº¥y táº¥t cáº£)
        if domain is None:
            domain = []
            
        # Äá»c dá»¯ liá»‡u tá»« cÃ¡c báº£n ghi dá»± Ä‘oÃ¡n Ä‘Ã£ Ä‘Æ°á»£c lá»c
        predictions = self.search_read(
            domain,
            ['is_high_risk', 'probability', 'churn_rate']
        )
        
        # Láº¥y tá»•ng sá»‘ báº£n ghi dá»± Ä‘oÃ¡n (trÆ°á»›c khi lá»c) Ä‘á»ƒ tÃ­nh tá»· lá»‡ %
        total_predictions_overall = self.search_count([])

        total_predictions_in_group = len(predictions)
        high_risk_customers = sum(p['is_high_risk'] for p in predictions)
        
        # TÃ­nh toÃ¡n Ä‘á»ƒ trÃ¡nh lá»—i chia cho 0
        average_churn_probability = 0
        overall_churn_rate = 0
        high_risk_percentage = 0

        if total_predictions_in_group > 0:
            average_churn_probability = sum(p['probability'] for p in predictions) / total_predictions_in_group
            overall_churn_rate = sum(p['churn_rate'] for p in predictions) / total_predictions_in_group
        
        if total_predictions_overall > 0:
            # Tá»· lá»‡ % khÃ¡ch hÃ ng rá»§i ro cao cá»§a nhÃ³m hiá»‡n táº¡i so vá»›i Tá»”NG Sá»
            high_risk_percentage = (high_risk_customers / total_predictions_overall) * 100

        return {
            'total_predictions': total_predictions_in_group,
            'high_risk_customers': high_risk_customers,
            'average_churn_probability': round(average_churn_probability, 2),
            'overall_churn_rate': round(overall_churn_rate, 2),
            'high_risk_percentage': round(high_risk_percentage, 1), # Dá»¯ liá»‡u cho progress bar
        }
        
    def action_generate_ai_explanation(self):
        """
        [ÄÃƒ Sá»¬A] Chuyá»ƒn sang sá»­ dá»¥ng API cá»§a OpenAI (GPT) Ä‘á»ƒ táº¡o giáº£i thÃ­ch.
        """
        self.ensure_one()
        
        _logger.info(">>> [AI XAI - OpenAI] Báº¯t Ä‘áº§u action_generate_ai_explanation cho prediction ID: %d", self.id)

        # --- BÆ¯á»šC 1: Láº¤Y Cáº¤U HÃŒNH (ÄÃƒ Sá»¬A) ---
        config_param = self.env['ir.config_parameter'].sudo()
        # <<< THAY Äá»”I: Láº¥y key vÃ  endpoint cá»§a OpenAI >>>
        api_key = config_param.get_param('churn_predictor.openai_api_key')
        api_endpoint = config_param.get_param('churn_predictor.openai_api_endpoint')

        if not api_key or not api_endpoint or api_key == 'sk-YourSecretKeyHere':
            raise UserError(_("OpenAI API is not configured. Please set your API key in Technical Settings."))
        
        if not self.shap_data_json:
            raise UserError(_("No SHAP data available."))

        # --- BÆ¯á»šC 2: CHUáº¨N Bá»Š Dá»® LIá»†U VÃ€ PROMPT (Giá»¯ nguyÃªn logic cÅ©) ---
        # (ToÃ n bá»™ logic chuáº©n bá»‹ prompt cá»§a báº¡n tá»« BÆ¯á»šC 2 Ä‘áº¿n BÆ¯á»šC 3 váº«n giá»¯ nguyÃªn)
        try:
            shap_data = json.loads(self.shap_data_json)
        except json.JSONDecodeError:
            raise UserError(_("Could not read the SHAP data."))

        feature_impacts = sorted(
            zip(shap_data['feature_names'], shap_data['shap_values'], shap_data['feature_values']),
            key=lambda x: abs(x[1]),
            reverse=True
        )
        
        # --- BÆ¯á»šC 2.1: Láº¤Y Dá»® LIá»†U Bá»I Cáº¢NH (CONTEXT DATA) ---
        
        # 1. Product Category
        raw_category = self.customer_id.x_feat_product_category_name_english_last or "Unknown"
        customer_category = raw_category.replace('_', ' ').title()

        # 2. CÃ¡c chá»‰ sá»‘ hÃ nh vi & Segment
        personal_gap = self.customer_id.x_feat_personal_avg_gap or 0.0
        category_gap = self.customer_id.x_feat_category_avg_gap or 0.0
        segment_id = self.customer_id.x_feat_segment or 0

        # === [NEW] LOGIC Äá»ŠNH NGHÄ¨A SEGMENT ===
        segment_definitions = {
            0: """**Segment 0: "KhÃ¡ch hÃ ng Má»›i / Tiá»m nÄƒng" (New & Active Low Value)**
            - ChÃ¢n dung: KhÃ¡ch má»›i hoáº·c hay sÄƒn sale, Recency tá»‘t nhÆ°ng chÆ°a dÃ¡m chi lá»›n.
            - Chiáº¿n lÆ°á»£c: Dá»… chuyá»ƒn Ä‘á»•i nháº¥t. HÃ£y Cross-sell sáº£n pháº©m giÃ¡ trá»‹ cao hÆ¡n hoáº·c bÃ¡n theo Combo.""",
            
            1: """**Segment 1: "VIP Ngá»§ Ä‘Ã´ng" (At-Risk VIP)**
            - ChÃ¢n dung: Tá»«ng chi ráº¥t nhiá»u tiá»n cho mÃ³n giÃ¡ trá»‹ lá»›n nhÆ°ng Ä‘ang cÃ³ dáº¥u hiá»‡u rá»i bá» (Churn).
            - Chiáº¿n lÆ°á»£c: Cáº§n chiáº¿n dá»‹ch 'Win-back' kháº©n cáº¥p. Gá»­i email nháº¯c nhá»Ÿ, Ä‘á» xuáº¥t phá»¥ kiá»‡n Ä‘i kÃ¨m mÃ³n Ä‘Ã£ mua.""",
            
            2: """**Segment 2: "KhÃ¡ch hÃ ng NgÃ´i sao" (Active High Value)**
            - ChÃ¢n dung: KhÃ¡ch hÃ ng lÃ½ tÆ°á»Ÿng, chi tiÃªu cao, má»›i tÆ°Æ¡ng tÃ¡c. Äang 'nuÃ´i sá»‘ng' doanh nghiá»‡p.
            - Chiáº¿n lÆ°á»£c: ChÄƒm sÃ³c Ä‘áº·c biá»‡t, upsell, gá»­i mÃ£ giáº£m giÃ¡ khuyáº¿n khÃ­ch mua tiáº¿p. Äá»«ng Ä‘á»ƒ há» nguá»™i láº¡nh.""",
            
            3: """**Segment 3: "KhÃ¡ch hÃ ng Phá»• thÃ´ng Ä‘ang trÃ´i Ä‘i" (Drifting)**
            - ChÃ¢n dung: Mua Ä‘á»“ giÃ¡ trá»‹ nhá», Ä‘Ã£ báº¯t Ä‘áº§u quÃªn lÃ£ng thÆ°Æ¡ng hiá»‡u. Sá»‘ lÆ°á»£ng Ä‘Ã´ng.
            - Chiáº¿n lÆ°á»£c: Giá»¯ liÃªn láº¡c duy trÃ¬ (newsletter), khÃ´ng tá»‘n quÃ¡ nhiá»u ngÃ¢n sÃ¡ch marketing.""",
            
            4: """**Segment 4: "KhÃ¡ch hÃ ng ÄÃ£ máº¥t / KÃ©m hiá»‡u quáº£" (Lost / Low Value)**
            - ChÃ¢n dung: Mua mÃ³n ráº» tiá»n tá»« ráº¥t lÃ¢u, khÃ´ng quay láº¡i.
            - Chiáº¿n lÆ°á»£c: KhÃ´ng nÃªn tá»‘n chi phÃ­ quáº£ng cÃ¡o (ROI tháº¥p)."""
        }
        
        # Láº¥y Ä‘á»‹nh nghÄ©a cho khÃ¡ch hÃ ng hiá»‡n táº¡i (Máº·c Ä‘á»‹nh lÃ  Segment 3 náº¿u khÃ´ng tÃ¬m tháº¥y)
        current_segment_info = segment_definitions.get(segment_id, segment_definitions[3])

        # 3. Láº¥y Lá»‹ch sá»­ tÆ°Æ¡ng tÃ¡c
        history_log = ""
        try:
            timeline_data = self.customer_id.get_interaction_timeline_data(self.customer_id.id)
            timeline_list = timeline_data.get('timeline', [])
            if timeline_list:
                recent_events = timeline_list[:10] 
                log_lines = []
                for event in recent_events:
                    desc = event['description']
                    if len(desc) > 100: desc = desc[:100] + "..."     
                    line = f"- {event['date']} [{event['channel']}]: {event['title']} - {desc}"
                    log_lines.append(line)
                history_log = "\n".join(log_lines)
            else:
                history_log = "ChÆ°a cÃ³ lá»‹ch sá»­ tÆ°Æ¡ng tÃ¡c nÃ o."
        except Exception:
            history_log = "KhÃ´ng thá»ƒ truy xuáº¥t lá»‹ch sá»­ tÆ°Æ¡ng tÃ¡c."

        # --- BÆ¯á»šC 2.2: Xá»¬ LÃ TEXT SHAP ---
        top_n = 7
        features_description = ""
        count = 0
        for name, shap_val, feature_val in feature_impacts[:top_n]:
            if count >= top_n: break
            if name.startswith('bert_') or name.startswith('tfidf_'): continue
            direction = "tÄƒng" if shap_val > 0 else "giáº£m"
            features_description += f"- {name} = {feature_val:.2f}: lÃ m {direction} nguy cÆ¡ churn (Ä‘á»™ máº¡nh: {shap_val:.4f})\n"
            count += 1

        prediction_summary = "Rá»œI Bá» (Churn)" if self.prediction_result == 'churn' else "á» Láº I (No Churn)"

        # --- BÆ¯á»šC 3: XÃ‚Y Dá»°NG PROMPT (ÄÃƒ Tá»I Æ¯U HÃ“A SEGMENT) ---
        prompt = f"""
        **Vai trÃ²:** Báº¡n lÃ  chuyÃªn gia tÆ° váº¥n chiáº¿n lÆ°á»£c khÃ¡ch hÃ ng (Customer Strategy Consultant). HÃ£y phÃ¢n tÃ­ch vÃ  Ä‘Æ°a ra giáº£i phÃ¡p hÃ nh Ä‘á»™ng cá»¥ thá»ƒ báº±ng tiáº¿ng Viá»‡t (Markdown).

        **1. Há»“ sÆ¡ KhÃ¡ch hÃ ng & PhÃ¢n khÃºc (Quan trá»ng):**
        - **NgÃ nh hÃ ng quan tÃ¢m:** {customer_category}
        - **PhÃ¢n loáº¡i PhÃ¢n khÃºc (Segment):** 
        {current_segment_info}
        
        - **Chá»‰ sá»‘ Chu ká»³ mua sáº¯m (Gap Analysis):**
          + CÃ¡ nhÃ¢n khÃ¡ch nÃ y: {personal_gap:.2f} ngÃ y/láº§n
          + Trung bÃ¬nh ngÃ nh hÃ ng: {category_gap:.2f} ngÃ y/láº§n
          (Gá»£i Ã½: Náº¿u CÃ¡ nhÃ¢n > NgÃ nh hÃ ng nghÄ©a lÃ  khÃ¡ch mua cháº­m hÆ¡n thá»‹ trÆ°á»ng -> Rá»§i ro).

        **2. DÃ²ng thá»i gian tÆ°Æ¡ng tÃ¡c (Gáº§n nháº¥t trÆ°á»›c):**
        {history_log}

        **3. Káº¿t quáº£ Dá»± bÃ¡o AI:**
        - **Dá»± Ä‘oÃ¡n:** {prediction_summary}
        - **XÃ¡c suáº¥t Churn:** {self.probability:.2f}%
        
        **4. Dá»¯ liá»‡u SHAP (CÃ¡c yáº¿u tá»‘ áº£nh hÆ°á»Ÿng ká»¹ thuáº­t):**
        {features_description}

        ---
        **YÃªu cáº§u Ä‘áº§u ra (Output Format):**
        
        **Tá»•ng quan:** [ÄÃ¡nh giÃ¡ ngáº¯n gá»n tÃ¬nh tráº¡ng khÃ¡ch hÃ ng dá»±a trÃªn PhÃ¢n khÃºc vÃ  XÃ¡c suáº¥t Churn].

        **ğŸ”´ Váº¥n Ä‘á» & Rá»§i ro:**
        - **[TÃªn váº¥n Ä‘á»]:** [Giáº£i thÃ­ch dá»±a trÃªn Gap Analysis vÃ  SHAP].
        
        **ğŸŸ¢ Äiá»ƒm sÃ¡ng:**
        - **[TÃªn Ä‘iá»ƒm tá»‘t]:** [Giáº£i thÃ­ch].

        **ğŸš€ Chiáº¿n lÆ°á»£c HÃ nh Ä‘á»™ng (Dá»±a trÃªn Segment {segment_id}):**
        - **[HÃ nh Ä‘á»™ng 1 - Cá»¥ thá»ƒ]:** [Dá»±a trÃªn pháº§n 'Chiáº¿n lÆ°á»£c' cá»§a Segment {segment_id} á»Ÿ trÃªn, hÃ£y cá»¥ thá»ƒ hÃ³a nÃ³ cho ngÃ nh hÃ ng {customer_category}. VÃ­ dá»¥: Náº¿u lÃ  VIP Ngá»§ Ä‘Ã´ng ngÃ nh Furniture, hÃ£y gá»£i Ã½ gá»­i catalog ná»™i tháº¥t má»›i].
        - **[HÃ nh Ä‘á»™ng 2 - TÆ°Æ¡ng tÃ¡c]:** [Dá»±a trÃªn lá»‹ch sá»­ tÆ°Æ¡ng tÃ¡c gáº§n nháº¥t].

        **LÆ°u Ã½:** HÃ£y bÃ¡m sÃ¡t Ä‘á»‹nh nghÄ©a cá»§a Segment {segment_id} Ä‘á»ƒ Ä‘Æ°a ra lá»i khuyÃªn. Äá»«ng Ä‘Æ°a ra lá»i khuyÃªn chung chung.
        """
        
        # --- BÆ¯á»šC 4: Gá»ŒI API (NO SSL) ---
        headers = {
            'Content-Type': 'application/json',
            'Authorization': f'Bearer {api_key}' # OpenAI dÃ¹ng Bearer Token Authentication
        }
        
        payload = {
            "model": "gpt-4o-mini", # Hoáº·c "gpt-3.5-turbo", "gpt-4o". gpt-4o-mini ráº» vÃ  nhanh.
            "messages": [
                {
                    "role": "user",
                    "content": prompt
                }
            ],
            "temperature": 0.7,
            "max_tokens": 2048
        }
        
        try:
            response = requests.post(
                api_endpoint, 
                headers=headers, 
                json=payload,
                timeout=60 # TÄƒng timeout cho cÃ¡c model lá»›n
            )
            response.raise_for_status() # Tá»± Ä‘á»™ng bÃ¡o lá»—i náº¿u status code lÃ  4xx hoáº·c 5xx
            
            response_data = response.json()
            
            # <<< THAY Äá»”I: CÃ¡ch láº¥y ná»™i dung tráº£ vá» tá»« OpenAI >>>
            if 'choices' in response_data and response_data['choices']:
                raw_explanation_md = response_data['choices'][0]['message']['content']
                finish_reason = response_data['choices'][0].get('finish_reason')
                
                html_explanation = markdown2.markdown(raw_explanation_md)
                
                if finish_reason == 'length':
                    html_explanation += "<p><em>(Káº¿t quáº£ bá»‹ cáº¯t ngáº¯n do giá»›i háº¡n Ä‘á»™ dÃ i token.)</em></p>"

                self.write({'shap_ai_explanation': html_explanation})
                _logger.info(">>> ÄÃ£ lÆ°u káº¿t quáº£ XAI tá»« OpenAI thÃ nh cÃ´ng.")
            else:
                # Ghi log response lá»—i Ä‘á»ƒ debug
                _logger.error("Pháº£n há»“i tá»« OpenAI khÃ´ng há»£p lá»‡: %s", response_data)
                raise UserError(_("AI returned an invalid response structure."))

        except requests.exceptions.HTTPError as e:
            # Ghi log chi tiáº¿t hÆ¡n vá» lá»—i HTTP
            _logger.error("Lá»—i HTTP khi gá»i OpenAI API: %s - Response: %s", e, e.response.text)
            raise UserError(_("Error calling OpenAI API: %s", e.response.text))
        except Exception as e:
            _logger.error("Lá»—i há»‡ thá»‘ng khi gá»i OpenAI: %s", e)
            raise UserError(_("System Error: %s", str(e)))

        return True

    def action_view_shap_logs(self):
        """
        HÃ m in log Ä‘Ã£ Ä‘Æ°á»£c nÃ¢ng cáº¥p Ä‘á»ƒ LOáº I Bá» cÃ¡c feature 'bert_'
        """
        self.ensure_one()
        _logger.info(">>> Báº¯t Ä‘áº§u in log SHAP cho Prediction ID: %d", self.id)

        if not self.shap_data_json:
            raise UserError(_("KhÃ´ng cÃ³ dá»¯ liá»‡u SHAP Ä‘á»ƒ phÃ¢n tÃ­ch."))

        try:
            shap_data = json.loads(self.shap_data_json)
        except json.JSONDecodeError:
            raise UserError(_("Dá»¯ liá»‡u SHAP bá»‹ lá»—i JSON."))

        # 1. Sáº¯p xáº¿p dá»¯ liá»‡u
        feature_impacts = sorted(
            zip(shap_data['feature_names'], shap_data['shap_values'], shap_data['feature_values']),
            key=lambda x: abs(x[1]),
            reverse=True
        )

        # ==============================================================================
        # IN Báº¢NG LOG (ÄÃƒ Lá»ŒC BERT)
        # ==============================================================================
        debug_msg = ["\n" + "â–’" * 90]
        debug_msg.append(f" ğŸ•µï¸ [MANUAL CHECK] Báº¢NG PHÃ‚N TÃCH SHAP LOGS (NO BERT)")
        debug_msg.append(f" Customer: {self.customer_name} | Probability: {self.probability:.2f}%")
        debug_msg.append("â–’" * 90)
        debug_msg.append(f"{'RANK':<5} | {'FEATURE NAME':<45} | {'VALUE':<12} | {'IMPACT':<10} | {'EFFECT'}")
        debug_msg.append("-" * 90)

        # Biáº¿n Ä‘áº¿m thá»© háº¡ng hiá»ƒn thá»‹ (vÃ¬ i sáº½ bá»‹ nháº£y cÃ³c khi skip bert)
        display_rank = 1

        for name, shap_val, feature_val in feature_impacts:
            # === ÄOáº N QUAN TRá»ŒNG: Lá»ŒC Bá» BERT ===
            if name.startswith('bert_') or name.startswith('tfidf_'): 
                continue 
            # ====================================

            direction = "TÄ‚NG ğŸ”´" if shap_val > 0 else "GIáº¢M ğŸŸ¢"
            
            # Cáº¯t ngáº¯n tÃªn náº¿u quÃ¡ dÃ i Ä‘á»ƒ báº£ng Ä‘áº¹p hÆ¡n
            display_name = (name[:42] + '..') if len(name) > 42 else name
            
            line = f"#{display_rank:02d}   | {display_name:<45} | {feature_val:>10.2f}   | {shap_val:>10.4f}   | {direction}"
            debug_msg.append(line)
            display_rank += 1
            
        debug_msg.append("=" * 90 + "\n")
        _logger.info("\n".join(debug_msg))

        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': 'Check Docker Logs',
                'message': 'ÄÃ£ in báº£ng phÃ¢n tÃ­ch (Ä‘Ã£ lá»c bá» Bert) ra terminal.',
                'type': 'success',
                'sticky': False,
            }
        }

    def action_send_ai_explanation_email(self):
        """
        Action gá»­i email phÃ¢n tÃ­ch AI.
        [PHIÃŠN Báº¢N CUá»I]: Thá»±c hiá»‡n AI Call thá»© hai vÃ  Ä‘iá»n thÃ´ng tin thÆ°Æ¡ng hiá»‡u vÃ o email.
        """
        self.ensure_one()
        import os
        import re

        _logger.info(">>> [Email AI] Báº¯t Ä‘áº§u gá»­i email phÃ¢n tÃ­ch cho KH: %s", self.customer_id.name)

        if not self.shap_ai_explanation:
            raise UserError(_("ChÆ°a cÃ³ ná»™i dung phÃ¢n tÃ­ch AI. Vui lÃ²ng cháº¡y 'Explain with AI' trÆ°á»›c."))
        if not self.customer_id or not self.customer_id.email:
            raise UserError(_("KhÃ¡ch hÃ ng nÃ y khÃ´ng cÃ³ Ä‘á»‹a chá»‰ email há»£p lá»‡."))

        customer_segment = self.customer_id.x_feat_segment
        template_map = {
            0: 'ChurnPredictor.email_template_ai_segment_0',
            1: 'ChurnPredictor.email_template_ai_segment_1',
            2: 'ChurnPredictor.email_template_ai_segment_2',
            3: 'ChurnPredictor.email_template_ai_segment_3',
            4: 'ChurnPredictor.email_template_ai_segment_4',
        }
        template_xml_id = template_map.get(customer_segment)
        if not template_xml_id:
            raise UserError(_("KhÃ´ng tÃ¬m tháº¥y máº«u email cho segment '%s'.", customer_segment))
        try:
            template = self.env.ref(template_xml_id)
        except ValueError:
            raise UserError(_("Template '%s' khÃ´ng tá»“n táº¡i.", template_xml_id))
            
        try:
            config_param = self.env['ir.config_parameter'].sudo()
            api_key = config_param.get_param('churn_predictor.openai_api_key')
            api_endpoint = config_param.get_param('churn_predictor.openai_api_endpoint')

            if not api_key or not api_endpoint or api_key == 'sk-YourSecretKeyHere':
                raise UserError(_("OpenAI API is not configured. Please set your API key in Technical Settings."))

            internal_analysis_html = self.shap_ai_explanation
            internal_analysis_text = re.sub('<[^<]+?>', ' ', internal_analysis_html).strip()

            email_prompt = f"""
            **Vai trÃ²:** Báº¡n lÃ  má»™t chuyÃªn gia Viáº¿t ná»™i dung Marketing (Marketing Copywriter), ráº¥t giá»i trong viá»‡c chuyá»ƒn hÃ³a dá»¯ liá»‡u phÃ¢n tÃ­ch khÃ´ khan thÃ nh nhá»¯ng email cÃ¡ nhÃ¢n hÃ³a, áº¥m Ã¡p vÃ  cÃ³ tÃ­nh thuyáº¿t phá»¥c cao.

            **Bá»‘i cáº£nh:** Báº¡n nháº­n Ä‘Æ°á»£c má»™t báº£n phÃ¢n tÃ­ch ná»™i bá»™ vá» má»™t khÃ¡ch hÃ ng. Nhiá»‡m vá»¥ cá»§a báº¡n lÃ  dá»±a vÃ o báº£n phÃ¢n tÃ­ch nÃ y Ä‘á»ƒ viáº¿t ná»™i dung cho má»™t email sáº½ Ä‘Æ°á»£c gá»­i **TRá»°C TIáº¾P** Ä‘áº¿n khÃ¡ch hÃ ng Ä‘Ã³.

            **Dá»¯ liá»‡u phÃ¢n tÃ­ch ná»™i bá»™ (Input):**
            ---
            {internal_analysis_text}
            ---

            **YÃªu cáº§u Ä‘áº§u ra (Output Format):**

            1.  **Má»¥c tiÃªu:** Viáº¿t láº¡i ná»™i dung trÃªn thÃ nh má»™t vÃ i Ä‘oáº¡n vÄƒn ngáº¯n gá»n, thÃ¢n thiá»‡n, vÃ  tá»± nhiÃªn Ä‘á»ƒ Ä‘Æ°a vÃ o thÃ¢n email.
            2.  **NgÃ´i xÆ°ng hÃ´:** NÃ³i chuyá»‡n trá»±c tiáº¿p vá»›i khÃ¡ch hÃ ng. Sá»­ dá»¥ng cÃ¡c tá»« nhÆ° "QuÃ½ khÃ¡ch", "báº¡n", "cá»§a báº¡n".
            3.  **GIá»ŒNG VÄ‚N QUAN TRá»ŒNG NHáº¤T:**
                -   **Tuyá»‡t Ä‘á»‘i khÃ´ng** sá»­ dá»¥ng cÃ¡c tá»« ngá»¯ cá»§a báº£n phÃ¢n tÃ­ch nhÆ° "phÃ¢n khÃºc", "xÃ¡c suáº¥t churn", "rá»§i ro", "Ä‘iá»ƒm sÃ¡ng", "chiáº¿n lÆ°á»£c hÃ nh Ä‘á»™ng", "dá»¯ liá»‡u SHAP".
                -   Thay vÃ o Ä‘Ã³, hÃ£y diá»…n giáº£i Ã½ nghÄ©a cá»§a chÃºng. VÃ­ dá»¥, thay vÃ¬ nÃ³i "Váº¥n Ä‘á»: khÃ¡ch hÃ ng chÆ°a Ä‘Ã¡nh giÃ¡ sáº£n pháº©m", hÃ£y viáº¿t thÃ nh "ChÃºng tÃ´i nháº­n tháº¥y báº¡n chÆ°a cÃ³ dá»‹p chia sáº» cáº£m nháº­n vá» sáº£n pháº©m XYZ. Má»—i Ã½ kiáº¿n cá»§a báº¡n Ä‘á»u ráº¥t quÃ½ giÃ¡...".
                -   Thay vÃ¬ liá»‡t kÃª "Chiáº¿n lÆ°á»£c hÃ nh Ä‘á»™ng", hÃ£y biáº¿n nÃ³ thÃ nh má»™t lá»i má»i gá»i háº¥p dáº«n. VÃ­ dá»¥: "Äá»ƒ giÃºp báº¡n cÃ³ tráº£i nghiá»‡m tá»‘t hÆ¡n vá»›i dÃ²ng sáº£n pháº©m [tÃªn ngÃ nh hÃ ng], chÃºng tÃ´i xin gá»­i táº·ng báº¡n má»™t Æ°u Ä‘Ã£i Ä‘áº·c biá»‡t...".
            4.  **Äá»‹nh dáº¡ng:** Chá»‰ cáº§n tráº£ vá» ná»™i dung text hoáº·c markdown Ä‘Æ¡n giáº£n. KhÃ´ng cáº§n cÃ¡c tiÃªu Ä‘á» hay icon ğŸ”´ğŸŸ¢ğŸš€.
            """

            headers = {'Content-Type': 'application/json', 'Authorization': f'Bearer {api_key}'}
            payload = {
                "model": "gpt-4o-mini",
                "messages": [{"role": "user", "content": email_prompt}],
                "temperature": 0.8,
                "max_tokens": 1024
            }

            response = requests.post(api_endpoint, headers=headers, json=payload, timeout=60)
            response.raise_for_status()
            response_data = response.json()
            
            customer_facing_content_md = ""
            if 'choices' in response_data and response_data['choices']:
                customer_facing_content_md = response_data['choices'][0]['message']['content']
            else:
                raise UserError(_("AI failed to translate the analysis into an email."))
            
            # --------------------------------------------------------------------------
            # BÆ¯á»šC c: [Má»šI] THAY THáº¾ CÃC PLACEHOLDER Báº°NG Dá»® LIá»†U THáº¬T
            # --------------------------------------------------------------------------
            
            # Láº¥y thÃ´ng tin tá»« System Parameters (cÃ¡ch lÃ m chuyÃªn nghiá»‡p)
            # Náº¿u chÆ°a cÃ³, nÃ³ sáº½ dÃ¹ng giÃ¡ trá»‹ máº·c Ä‘á»‹nh báº¡n cung cáº¥p
            brand_name = config_param.get_param('churn_predictor.brand_name', 'Churn Predictor')
            sender_name = config_param.get_param('churn_predictor.sender_name', 'Quá»‘c Khang')
            sender_title = config_param.get_param('churn_predictor.sender_title', 'CEO of Churn Predictor')
            contact_info = config_param.get_param('churn_predictor.contact_info', '0333925926')

            # Thá»±c hiá»‡n thay tháº¿
            final_md = customer_facing_content_md.replace('[TÃªn thÆ°Æ¡ng hiá»‡u]', brand_name) \
                                                .replace('[TÃªn Báº¡n]', sender_name) \
                                                .replace('[TÃªn báº¡n]', sender_name) \
                                                .replace('[Chá»©c vá»¥]', sender_title) \
                                                .replace('[ThÃ´ng tin liÃªn há»‡]', contact_info)

            # Chuyá»ƒn káº¿t quáº£ cuá»‘i cÃ¹ng sang HTML
            customer_facing_html = markdown2.markdown(final_md)

            # --------------------------------------------------------------------------
            # BÆ¯á»šC d: RENDER VÃ€ Gá»¬I EMAIL
            # --------------------------------------------------------------------------
            
            rendered_subject = template._render_template(template.subject, 'churn.prediction', [self.id])[self.id]
            rendered_body = template._render_template(template.body_html, 'churn.prediction', [self.id])[self.id]

            # Thay tháº¿ placeholder chÃ­nh trong template XML
            final_body = rendered_body.replace('__AI_HTML_CONTENT__', customer_facing_html)
            # Thay tháº¿ placeholder cuá»‘i cÃ¹ng trong template XML
            final_body = final_body.replace('[TÃªn CÃ´ng ty cá»§a báº¡n]', brand_name)
            
            sender_email = os.environ.get('SMTP_USER') or 'noreply@yourcompany.com'

            mail_values = {
                'subject': rendered_subject,
                'body_html': final_body, 
                'email_to': self.customer_id.email,
                'email_from': f'"{sender_name} ({brand_name})" <{sender_email}>',
                'author_id': self.env.user.partner_id.id,
                'state': 'outgoing',
                'auto_delete': True,
            }

            mail = self.env['mail.mail'].sudo().create(mail_values)
            mail.send(raise_exception=False)
            
            _logger.info("ÄÃ£ gá»­i email AI (Template: %s, Ä‘Ã£ qua chuyá»ƒn Ä‘á»•i) tá»›i %s", template_xml_id, self.customer_id.email)

        except Exception as e:
            _logger.error("Lá»—i trong quÃ¡ trÃ¬nh gá»­i email AI: %s", e)
            raise UserError(_("An error occurred while preparing or sending the AI email: %s", e))

        self.customer_id.message_post(
            body=_("Email phÃ¢n tÃ­ch (Ä‘Æ°á»£c cÃ¡ nhÃ¢n hÃ³a bá»Ÿi AI) Ä‘Ã£ Ä‘Æ°á»£c gá»­i tá»›i %s.", self.customer_id.email),
            subtype_xmlid='mail.mt_note'
        )

        return True